This code exactly matches Ed Olson's original c implementation